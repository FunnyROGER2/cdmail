# Ampier

## Ссылки
- [Репозиторий статичных файлов (графика и т.д.)](https://gitlab.vestabankdev.ru/frontend/static)
- [Обзор Ampier (в Confluence)](https://confluence.blanc.ru/pages/viewpage.action?pageId=1739392910)
- [UI-kit для e-mail](https://www.figma.com/file/ovW0ciTxuAvPgA5r0pFoWT/%D0%9E%D0%B1%D1%89%D0%B8%D0%B5-%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F?type=design&node-id=1137-1593&mode=design&t=wl4qcKjJd4wz4ST9-4)
## Структура репозитория

```
email
 ├ ampier
 │ ├ config
 │ │ ├ mocks.js
 │ │ └ vars.js
 │ ├ dist
 │ ├ favicons
 │ ├ img (ignored)
 │ ├ imgSrc
 │ ├ render (ignored)
 │ ├ src
 │ ├ styles
 │ │ ├ adaptive.scss
 │ │ ├ base.scss
 │ │ ├ mixins.scss
 │ │ └ vars.scss (ignored)
 │ └ templates
 ├ email-notification
 ├ mjml
 └ old
 ```

- Папка `/ampier` содержит все файлы, касающиеся актуальной вёрстки писем
  - `/config` — файлы с моковыми данными и прочими переменными, которые - заменяются в шаблонах и стилях на указанные значения
  - `/dist` — готовые html-файлы для разработки
  - `/img` — сжатые картинки, которые можно копировать в static-репозиторий
  - `/imgSrc` — исходные картинки, кладём именно сюда
  - `/render` — скомпилированные html-файлы для dev-режима
  - `/src` — исходные html-файлы с вёрсткой на TJML и переменными из `/config`
  - `/styles` — стили, которые будут инлайниться для десктопа и вставляться, как есть, для адаптива
  - `/templates` — шаблонные части для html-файлов
- `/email-notification` относится к вёрстке страниц подписки, подробнее в статье Вёрстка статики для сервиса SendSay
- `/mjml` содержит вёрстку первоначальной версии на MJML
- В `/old` находятся файлы писем, свёрстанные в прошлом, без фреймворков

### Файлы в корне Ampier

- `.editorconfig` — базовые настройки форматирования для IDE
- `.prettierrc` — параметры форматирования для HTML
- `.stylelintrc` — настройки Stylelint для SCSS
- `gulpfile.js` — файл таск-менеджера Gulp
- `index.html` (ignored) — скомпилированный список писем, отображается в браузере при запуске dev-режимов
- `main.css` — стили для веб-интерфейса Ampier (сохранены локально с небольшими изменениями)
- `main.js` — основной JS-файл Ampier (сохранён локально, адаптирован под NodeJS и наши нужды)
- `package.json` — файл конфигурации npm
- `web-types.json` — конфиг автокомплита тегов TJML для WebStorm и PhpStorm
- `yarn.lock` — https://habr.com/ru/companies/alfa/articles/705876/

## Команды сборки

- `npm run start` — стандартная быстрая сборка (без компиляции готовых шаблонов в папку `/dist`)
- `npm run build:watc`h — медленная компиляция с отслеживанием изменений и компиляций dist-файлов
- `npm run start:ampierOriginal` — быстрая сборка с использование оригинальных онлайн-версий ampier-файлов. Рекомендуется использовать только для ознакомления
- `npm run build` — разовая сборка готовых файлов в папку `/dist`

## Как работаем?

Ветку создаем по названию ветки бэка.

Исходные файлы письма в Ampier хранятся в папке `/ampier/src`, поддерживается вложенность. Работу фреймворка можно изучить в [документации](https://docs.ampier.io/framework/). Помимо стандартного функционала TJML в исходных шаблонах используются переменные вида `{{ templates.body-styles }}`, `{{ base }}`, `{{ imgPath }}`, `{{ vars.clBlack}}` и `{{ mocks.arrow }}`. Название до точки (при её наличии) указывает на тип переменной:

- `templates` — название html-шаблона из папки `/ampier/templates`. Содержимое файла будет вставлено на место переменной, как есть. Вложенность не поддерживается.
- `base` — основные стили, вставляются инлайном, используются для основной версии писем.
- `adaptive` — стили с медиазапросами, в первую очередь, для мобильной версии. Вставляются как есть, и работают там, где работают (современные мобильные и веб-клиенты)
- `imgPath` — переменная, которая заменяется на соответствующий конфиг из файла `/gulp/projectPath.js`: `projectPath.img.img` для dev-режима и  `projectPath.img.drop` — для build-режима.
- `vars` — переменные для стилизации, находятся в файле `/ampier/config/vars.js`. Используются в шаблонах и scss-файлах (автоматически конвертируются в нужные переменные вида $clBlack — файл `/ampier/styles/vars.scss`). Вложенность не поддерживается.
- `mocks` — переменные с моками. Внутри находятся 2 объекта — dev и prod. Нужные для каждого режима (dev и build) данные подтягиваются из соответствующего объекта. Большая вложенность не поддерживается.

Картинки (только PNG и JPG) с разрешением x2 кидаем в папку `/ampier/imgSrc/`. При сборке они сжимаются и попадают в папку `/ampier/img/`. После этого можно забирать их в static-репозиторий, создавая МР в ветке с таким же названием. После релиза МР они будут доступны с по пути https://static.blanc.ru/email/img/.

До релиза в качестве пути к изображениям следует использовать переменную `{{ imgPath }}`. В dev-режиме она будет замена на локальный путь до картинок, а в билде — на переменную с путём до прода. К сожалению, картинки со стейджей недоступны из-за VPN, и как следует протестировать письма не удастся, пока картинки не уйдут в прод.

### Важные моменты

- Для компонента `m-text` указываем только стили, отличающиеся от дефолтных (шаблон body-styles)
- Компонент `m-text` при указании атрибута `href` становится ссылкой. Но если ссылка должна находится среди обычного текста, то придется писать обычный тег `<a>` внутри `m-text`. При этом нужно указывать тегу `<a>` требуемые классы (например, `link` или `text-break`) и атрибут `target="_blank"`
- При написании стилей учитываем, что TJML-компоненты будут скомпилированы в сложную разметку, поэтому может понадобиться писать уродливые селекторы:


```
@media only screen and (max-width: #{$containerW}px) {
    .container {
        > table {
            > tbody {
                > tr {
                    > td {
                        padding-right: 16px !important;
                        padding-left: 16px !important;
                    }
                }
            }
        }
    }
    ...
}
```

- Для поддержки знака рубля на всех устройствах и клиентах требуется использовать шрифт, где он точно присутствует (Helvetica Neue). Для этого у нас есть класс `ruble`
- В веб-интерфейсе Ampier есть кнопки для отображения кода скомпилированного письма и его скачивания. Мы их не используем, поскольку код будет отличаться от кода в нашей сборке как минимум форматированием
- Цвета с прозрачностью (альфа-каналом) и вообще в форматах RGB и RGBA не везде поддерживаются, так что используем обычные непрозрачные HEX-цвета.

### Известные недостатки

- Вся сборка по сути является костылем для Ampier. Мы сохранили минифицированные скрипт и стили, адаптировали для своих нужд и использования в NodeJS
- Медленно билдится папка `/ampier/dist`. Это мелочь, но при изначально разработке письма работать приходится только с render-версией — быстрым dev-режимом без актуального наблюдения за окончательным результатом
- Нет полноценного шаблонизатора. Мы можем разбиваться шаблоны на статичные куски, но не передавать в них параметры, как в миксинах популярных шаблонизаторов, типа Pug. Внедрение слишком усложнило бы сборку, либо добавило определённые ограничения без ощутимого профита
- Кнопке (`m-button`) или ее прямому родителю (`m-wrap`) всегда требуется явно задавать ширину в пикселях для корректного отображения в Outlook и ему подобных клиентах. Эта мелкая проблема возникла в ходе адаптации Ampier для NodeJS
